---
name: Backend configuration system and secure storage
status: open
created: 2025-10-05T19:47:36Z
updated: 2025-10-05T19:51:23Z
github: https://github.com/tandelov/hotkey-prompt-refiner/issues/21
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Backend configuration system and secure storage

## Description

Implement the Rust backend configuration system with Tauri commands for settings management. Integrate secure API key storage using keyring-rs, create template persistence using JSON files in the config directory, and expose CRUD operations to the frontend via Tauri's IPC bridge. This backend infrastructure will support all configuration UI interactions.

## Acceptance Criteria

- [ ] Tauri commands implemented for settings CRUD (save_api_key, get_api_key, test_api_key, save_template, etc.)
- [ ] API key securely stored and retrieved using keyring-rs (system keychain)
- [ ] Template persistence working with JSON files in platform-specific config directory
- [ ] All commands properly error-handled and return structured responses
- [ ] Unit tests cover critical configuration operations

## Technical Details

**Implementation Approach:**
1. Add keyring-rs dependency to Cargo.toml
2. Create `src/commands.rs` for Tauri command handlers
3. Create `src/models.rs` for shared data structures (Template, Settings, etc.)
4. Implement secure API key storage:
   - `save_api_key(api_key: String) -> Result<()>`
   - `get_api_key() -> Result<Option<String>>`
   - `delete_api_key() -> Result<()>`
   - `test_api_key(api_key: String) -> Result<bool>` (validates with Anthropic API)
5. Implement template persistence:
   - `save_template(template: Template) -> Result<()>`
   - `get_templates() -> Result<Vec<Template>>`
   - `delete_template(id: String) -> Result<()>`
6. Use `directories` crate for platform-specific config paths
7. Register all commands in `src/main.rs` Tauri builder
8. Add comprehensive error types and handling

**Files Affected:**
- `src-tauri/Cargo.toml` - Add keyring-rs, directories dependencies
- `src-tauri/src/commands.rs` - New file for Tauri commands
- `src-tauri/src/models.rs` - New file for data structures
- `src-tauri/src/main.rs` - Register commands with Tauri
- `src-tauri/src/config.rs` - Configuration management logic (new file)

**Data Structures:**
```rust
#[derive(Serialize, Deserialize, Clone)]
struct Template {
    id: String,
    name: String,
    prompt: String,
    hotkey: Option<String>,
    created_at: String,
}

#[derive(Serialize, Deserialize)]
struct AppConfig {
    templates: Vec<Template>,
    default_model: String,
}
```

**Config Directory:**
- macOS: `~/Library/Application Support/com.hotkey-prompt-refiner/`
- Windows: `%APPDATA%\hotkey-prompt-refiner\`
- Linux: `~/.config/hotkey-prompt-refiner/`

## Dependencies

### Task Dependencies
- [ ] None - This is a foundational task

### External Dependencies
- [ ] Existing Anthropic API integration (src/anthropic.rs) for API key testing
- [ ] keyring-rs supports target platform
- [ ] System keychain accessible (may require permissions on macOS)

## Effort Estimate

**Size:** L

**Hours:** 6-8 hours

**Parallel:** true (can run in parallel with Task 20)

**Breakdown:**
- Tauri commands setup: 2 hours
- Keyring integration and testing: 2-3 hours
- Template persistence implementation: 2 hours
- Error handling and validation: 1-2 hours
- Unit tests: 1 hour

## Definition of Done

- [ ] All Tauri commands implemented and functional
- [ ] API key stored securely in system keychain
- [ ] Templates persist across application restarts
- [ ] test_api_key command validates credentials with Anthropic API
- [ ] Error handling covers edge cases (missing keychain access, file I/O errors)
- [ ] Unit tests pass for critical operations
- [ ] Platform-specific config paths work on macOS, Windows, Linux
- [ ] Code reviewed and follows project conventions
- [ ] Technical documentation added to relevant modules
