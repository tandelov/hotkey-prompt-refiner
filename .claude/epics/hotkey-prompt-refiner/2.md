---
name: Direct HTTP API Integration
status: open
created: 2025-10-04T15:52:52Z
updated: 2025-10-04T17:20:15Z
github: https://github.com/tandelov/hotkey-prompt-refiner/issues/2
depends_on: [8, 11]
parallel: false
conflicts_with: []
---

# Task: Direct HTTP API Integration

## Description
Implement direct HTTP communication with the Anthropic Claude API using `reqwest` and `serde_json` (no SDK crates). Implement prompt formatting (inject clipboard text into template) and API call execution. Handle authentication via headers, errors, and response streaming/buffering.

## Acceptance Criteria
- [ ] Successfully authenticate with Anthropic API using provided API key
- [ ] Format prompt by injecting clipboard text into template
- [ ] Send formatted prompt to Claude API
- [ ] Receive and buffer complete API response
- [ ] Handle API errors gracefully (auth failure, rate limits, network errors)
- [ ] Response returned as complete string for pasting

## Technical Details
**Implementation approach:**
- Direct HTTP requests using `reqwest` to `https://api.anthropic.com/v1/messages`
- JSON serialization/deserialization using `serde_json`
- Create `ApiClient` module in `src/anthropic.rs`
- Format prompt by replacing `{clipboard_text}` placeholder in template
- Use async/await with tokio runtime
- Buffer streaming response into complete string

**Code structure:**
```rust
// src/anthropic.rs
pub struct ApiClient {
    api_key: String,
    client: reqwest::Client,
}

impl ApiClient {
    pub fn new(api_key: String) -> Self
    pub async fn process_text(
        &self,
        prompt_template: &str,
        clipboard_text: &str
    ) -> Result<String, ApiError>
}
```

**Required HTTP Headers:**
- `x-api-key`: API key from environment
- `anthropic-version`: `2023-06-01`
- `content-type`: `application/json`

**API considerations:**
- Endpoint: `https://api.anthropic.com/v1/messages`
- Use Claude 3.5 Sonnet model (good balance of speed/quality)
- Set reasonable timeout (30 seconds)
- Handle rate limiting with clear error message
- Validate API key format before making call

## Dependencies
- [ ] Task 8 (Project Setup) - reqwest and serde_json crates available
- [ ] Task 11 (Configuration System) - API key and template loading

## Effort Estimate
- Size: M
- Hours: 6-8 hours
- Parallel: false (depends on config system)

## Definition of Done
- [ ] API call completes successfully with valid response
- [ ] Prompt formatting correctly injects clipboard text
- [ ] Error handling covers auth, network, and API errors
- [ ] Response buffered and returned as complete string
- [ ] Manual testing with real API key confirms functionality
- [ ] Clear error messages for common API issues
