---
name: API Integration with allm
status: open
created: 2025-10-04T15:52:52Z
updated: 2025-10-04T15:52:52Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 004]
parallel: false
conflicts_with: []
---

# Task: API Integration with allm

## Description
Integrate the `allm` library for Anthropic Claude API communication. Implement prompt formatting (inject clipboard text into template) and API call execution. Handle authentication, errors, and response streaming/buffering.

## Acceptance Criteria
- [ ] Successfully authenticate with Anthropic API using provided API key
- [ ] Format prompt by injecting clipboard text into template
- [ ] Send formatted prompt to Claude API
- [ ] Receive and buffer complete API response
- [ ] Handle API errors gracefully (auth failure, rate limits, network errors)
- [ ] Response returned as complete string for pasting

## Technical Details
**Implementation approach:**
- Use `allm` library for Claude API client
- Create `ApiClient` module
- Format prompt by replacing `{clipboard_text}` placeholder in template
- Use async/await with tokio runtime
- Buffer streaming response into complete string

**Code structure:**
```rust
// src/api_client.rs
pub struct ApiClient {
    api_key: String,
}

impl ApiClient {
    pub fn new(api_key: String) -> Self
    pub async fn process_text(
        &self,
        prompt_template: &str,
        clipboard_text: &str
    ) -> Result<String, ApiError>
}
```

**API considerations:**
- Use Claude 3.5 Sonnet model (good balance of speed/quality)
- Set reasonable timeout (30 seconds)
- Handle rate limiting with clear error message
- Validate API key format before making call

## Dependencies
- [ ] Task 001 (Project Setup) - allm crate available
- [ ] Task 004 (Configuration System) - API key and template loading

## Effort Estimate
- Size: M
- Hours: 6-8 hours
- Parallel: false (depends on config system)

## Definition of Done
- [ ] API call completes successfully with valid response
- [ ] Prompt formatting correctly injects clipboard text
- [ ] Error handling covers auth, network, and API errors
- [ ] Response buffered and returned as complete string
- [ ] Manual testing with real API key confirms functionality
- [ ] Clear error messages for common API issues
